# iParty Implementation Plan
**Story-Driven Autonomous Christmas Adventure Game**

**Target:** Christmas Day (Dec 25, 2024)
**Last Updated:** December 24, 2024

---

## Current State & Required Changes

### What's Wrong Now

**Screen Architecture is Backwards:**
- CoordinatorScreen: Shows admin dashboard (boring)
- PlayerScreen: Shows full story, challenges, and results
- Problem: Everyone staring at their phones instead of shared TV experience

**Missing Core Features:**
- No star rating system (sections pass/fail)
- No section retry mechanism
- Scoring has placement bonuses (wrong for cooperative game)
- Challenge generation is placeholder (simple math only)

### What We're Building

**Correct Architecture (Jackbox-style):**
- **Main Screen (TV)**: The actual game everyone watches together
  - Full story narrative and cinematics
  - Challenge questions (large, readable)
  - All players' submissions
  - Live scoreboard and results
  - Rich visuals with artwork
- **Player Devices (Phones)**: Simple input controllers
  - Just answer input field
  - Submit button
  - Personal score display
  - Minimal UI, no story content

**Core Game Mechanics:**
- 5 sections Ã— 3 challenges = 15 total rounds
- Each section needs â­â­â­ (3 stars) to pass
- Fail a section â†’ retry those 3 challenges
- Fully autonomous (no manual controls)
- Server validates all answers automatically

---

## Story Structure

```
Save Christmas Village - 5 Act Adventure

Act 1: Toy Machine Workshop (Rounds 1-3)
â”œâ”€ Story Intro (8s): "The toy machine is broken!"
â”œâ”€ Challenge 1: [Mini-game]
â”œâ”€ Challenge 2: [Mini-game]
â”œâ”€ Challenge 3: [Mini-game]
â””â”€ Section Complete: Check stars â†’ Pass (continue) or Fail (retry)

Act 2: Reindeer Stable (Rounds 4-6)
Act 3: Gift Wrapping Station (Rounds 7-9)
Act 4: Cookie Kitchen (Rounds 10-12)
Act 5: Sleigh Launch Pad (Rounds 13-15)

Victory: All 5 sections have 3 stars â†’ Christmas saved!
```

---

## Star Scoring System

### How Stars Are Earned (Team Performance)

**Per Section (3 challenges):**
```javascript
const totalCorrect = allCorrectAnswersFromAllPlayers; // Sum across all players
const totalPossible = numPlayers * 3; // 3 challenges Ã— number of players
const percentage = (totalCorrect / totalPossible) * 100;

if (percentage >= 80) stars = 3; // â­â­â­ PASS
if (percentage >= 60) stars = 2; // â­â­ RETRY
else stars = 1;                  // â­ RETRY
```

**Example (2 players, 6 total possible correct):**
- 5-6 correct (83-100%) â†’ â­â­â­ Pass, continue to next section
- 4 correct (67%) â†’ â­â­ Retry this section
- 0-3 correct (0-50%) â†’ â­ Retry this section

### Pass/Fail Logic

**Pass (â­â­â­):**
- Show success celebration
- Move to next section
- Unlock next part of story

**Fail (<3 stars):**
- Show retry message
- Reset section to beginning
- Replay same 3 challenges
- Can retry unlimited times

**Game Victory:**
- All 5 sections have â­â­â­
- Total: 15 stars earned
- Show victory screen

---

## Individual Points System

### Scoring Rules (Cooperative, Not Competitive)

**Every correct answer gets points:**
```javascript
// Base points
const basePoints = 100;

// Speed bonus (0-100 points based on time remaining)
const timeLimit = 60000; // 60 seconds
const timeRemaining = timeLimit - timeSpent;
const speedBonus = Math.floor((timeRemaining / timeLimit) * 100);

// Total
const totalPoints = basePoints + speedBonus;
// Range: 100-200 points per correct answer
```

**No placement bonuses** - this is cooperative!
Fast players naturally get more points from speed bonus.

**Incorrect answers:** 0 points

---

## Game State Flow

### State Machine

```
LOBBY
  â†“ (coordinator clicks Start)
INTRODUCTION (12s auto-advance)
  â†“
SECTION_INTRO (8s auto-advance)
  â†“
CHALLENGE_ACTIVE (60s or all submit)
  â†“
CHALLENGE_RESULTS (5s auto-advance)
  â†“
  If 3 challenges done in section:
    Calculate section stars
    If stars >= 3:
      SECTION_COMPLETE (5s) â†’ Next section
    Else:
      SECTION_FAILED (5s) â†’ Retry section
  Else:
    Next challenge
  â†“
After 5 sections complete:
  VICTORY
```

### What Shows on Each Screen

#### LOBBY

**Main Screen (TV):**
```
ğŸ„ iParty - Save Christmas! ğŸ„

Room Code: ABC123

Players Joined:
ğŸ‘¤ Mia (Age 17)
ğŸ‘¤ Lana (Age 15)

[START GAME]
```

**Player Device:**
```
iParty

You: Mia
Room: ABC123

Waiting for game to start...
(2 players)
```

---

#### INTRODUCTION

**Main Screen:**
```
[Santa Character Artwork]

"OH NO! The North Pole is in chaos!
The toy machines are broken, the
reindeer are lost, gifts are unwrapped..."

Help save Christmas by fixing
all 5 workshops!

(Auto-advances in 8 seconds)
```

**Player Device:**
```
You: Mia
â­ 0

Get ready...

Watch the main screen!
```

---

#### SECTION_INTRO

**Main Screen:**
```
[Toy Machine Workshop Background]

ğŸ Toy Machine Workshop

[Elf Character]

"The toy machines are jammed! Answer
these puzzles to get them working again!"

Section 1 of 5 â€¢ Need â­â­â­ to pass
```

**Player Device:**
```
You: Mia
â­ 0

ğŸ Section 1

Watch the TV!
Get ready...
```

---

#### CHALLENGE_ACTIVE

**Main Screen:**
```
[Toy Machine Workshop Background]

Challenge 1 of 3
â±ï¸ 0:45 remaining

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                            â”‚
â”‚   What is 13 + 7?          â”‚
â”‚                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Submissions:
âœ… Mia (answered)
â³ Lana (thinking...)
```

**Player Device:**
```
You: Mia
â­ 0   Points: 0

Your Answer:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ [_________]  â”‚ â† Input field
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

[SUBMIT ANSWER] â† Big button

â±ï¸ 0:45
```

---

#### CHALLENGE_RESULTS

**Main Screen:**
```
Challenge 1 - Results

Correct Answer: 20

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Lana    20  âœ…  +180 pts   â”‚ (fast!)
â”‚ Mia     20  âœ…  +120 pts   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Scoreboard:
1st Lana - 180 pts
2nd Mia  - 120 pts

(Next challenge in 5 seconds...)
```

**Player Device:**
```
You: Mia
â­ 0

âœ… CORRECT!

+120 points

Total: 120

Watch the TV for results!
```

---

#### SECTION_COMPLETE

**Main Screen:**
```
[Celebration Animation/Artwork]

ğŸ Toy Machine Workshop

â­â­â­ 3 STARS! SECTION PASSED!

"Great work! The toy machines are
running again! Toys for everyone!"

[Character celebrating]

Progress: 1 of 5 sections complete
Total Stars: â­â­â­ / 15
```

**Player Device:**
```
You: Mia

Section 1:
â­â­â­ PASSED!

Your Points: 280

Great job!
```

---

#### SECTION_FAILED (Retry)

**Main Screen:**
```
[Workshop Background - Darker]

ğŸ Toy Machine Workshop

â­â­ ONLY 2 STARS

Need 3 stars to fix the workshop!

[Sad elf character]
"Oh no! The machines are still broken.
Let's try again!"

RETRYING SECTION 1...
(Starting in 5 seconds)
```

**Player Device:**
```
You: Mia

Section Failed!
â­â­ / â­â­â­

Retrying...

Watch the TV
```

---

#### VICTORY

**Main Screen:**
```
[Victory Scene Artwork]

ğŸ„ CHRISTMAS IS SAVED! ğŸ„

All 5 workshops fixed!
Total Stars: â­â­â­â­â­â­â­â­â­â­â­â­â­â­â­

[All characters celebrating]

Final Scoreboard:
ğŸ¥‡ Lana - 1,240 pts (MVP!)
ğŸ¥ˆ Mia  - 1,105 pts

MERRY CHRISTMAS! ğŸ…
```

**Player Device:**
```
ğŸ„ YOU WON! ğŸ„

You: Mia
Rank: 2nd ğŸ¥ˆ

Final Score:
1,105 points

Christmas is saved!
```

---

## Implementation Tasks

### Phase 1: Fix Screen Architecture (HIGH PRIORITY)

**Files to Completely Redesign:**

1. **CoordinatorScreen.jsx** â†’ Main game experience
   - Current: Admin dashboard
   - Change to: Full cinematic game screen
   - Components needed:
     - `<IntroductionCinematic />`
     - `<SectionStoryScreen />`
     - `<ChallengeQuestionScreen />`
     - `<ResultsScreen />`
     - `<SectionCompleteScreen />`
     - `<SectionFailedScreen />`
     - `<VictoryScreen />`

2. **PlayerStoryScreen.jsx** â†’ Rename to PlayerInputScreen.jsx
   - Current: Full story and challenges
   - Change to: Minimal input controller
   - Keep only:
     - Name and score header
     - Input field (when challenge active)
     - Submit button
     - Personal feedback ("Correct!", "Wrong!")

**New Components to Create:**

```
client/src/components/
â”œâ”€â”€ coordinator/
â”‚   â”œâ”€â”€ IntroductionCinematic.jsx
â”‚   â”œâ”€â”€ SectionStoryScreen.jsx
â”‚   â”œâ”€â”€ ChallengeQuestionScreen.jsx
â”‚   â”œâ”€â”€ ResultsScreen.jsx
â”‚   â”œâ”€â”€ SectionCompleteScreen.jsx
â”‚   â”œâ”€â”€ SectionFailedScreen.jsx
â”‚   â””â”€â”€ VictoryScreen.jsx
â”œâ”€â”€ player/
â”‚   â”œâ”€â”€ PlayerHeader.jsx
â”‚   â”œâ”€â”€ InputForm.jsx
â”‚   â”œâ”€â”€ WaitingMessage.jsx
â”‚   â””â”€â”€ PersonalFeedback.jsx
â””â”€â”€ shared/
    â”œâ”€â”€ BackgroundLayer.jsx
    â”œâ”€â”€ CharacterDisplay.jsx
    â”œâ”€â”€ ScoreboardDisplay.jsx
    â””â”€â”€ StarProgress.jsx
```

### Phase 2: Implement Star System

**Server Changes:**

```javascript
// server/index.js

// Add to game state
game.sectionStars = [0, 0, 0, 0, 0]; // Track stars for each section
game.sectionResults = []; // Track results per section

// After section completes (3 challenges done)
function calculateSectionStars(sectionResults, numPlayers) {
  const totalCorrect = sectionResults.filter(r => r.isCorrect).length;
  const totalPossible = numPlayers * 3;
  const percentage = (totalCorrect / totalPossible) * 100;

  if (percentage >= 80) return 3;
  if (percentage >= 60) return 2;
  return 1;
}

// On section complete
const stars = calculateSectionStars(game.sectionResults, game.players.length);
game.sectionStars[currentSection - 1] = stars;

if (stars < 3) {
  // RETRY SECTION
  flowCoordinator.retrySection(io);
} else {
  // PASS - continue
  flowCoordinator.nextSection(io);
}
```

**FlowCoordinator Changes:**

```javascript
// server/utils/flowCoordinator.js

retrySection(io) {
  // Reset to beginning of current section
  const firstRoundOfSection = ((this.currentSection - 1) * 3) + 1;
  this.currentRound = firstRoundOfSection - 1; // Will increment in nextRound()

  // Clear section results
  this.sectionResults = [];

  // Show retry message
  this.transitionTo(io, GameState.SECTION_FAILED);
}

nextSection(io) {
  // Continue to next section or victory
  if (this.currentSection >= 5) {
    this.transitionTo(io, GameState.VICTORY);
  } else {
    this.transitionTo(io, GameState.MAP_TRANSITION);
  }
}
```

### Phase 3: Fix Scoring

**Remove placement bonuses from answerValidator.js:**

```javascript
// server/utils/answerValidator.js

function calculatePoints(isCorrect, timeSpent, scoring) {
  if (!isCorrect) return 0;

  const basePoints = scoring.correct || 100;

  // Speed bonus (0-100 based on time remaining)
  const timeLimit = scoring.timeLimit || 60000;
  const timeRemaining = Math.max(0, timeLimit - timeSpent);
  const speedBonus = Math.floor((timeRemaining / timeLimit) * 100);

  return basePoints + speedBonus;
  // NO placement bonuses!
}
```

### Phase 4: Artwork Integration

**Background Images (use as full-screen backgrounds):**
- Section 1: `bg-toy-machine.png`
- Section 2: `bg-reindeer-stable.png`
- Section 3: `bg-gift-wrap.png`
- Section 4: `bg-cookie-kitchen.png`
- Section 5: `bg-sleigh-launch.png`

**Character Images (display during story sections):**
- `santa-character.png` - Introduction
- `elf-character.png` - Workshop sections
- `reindeer-character.png` - Reindeer section

**UI Elements:**
- `game-logo.png` - Home screen, lobby
- `star-icon.png` - Replace â­ emoji
- `victory-scene.png` - Victory screen
- `celebration-burst.png` - Section complete animations

### Phase 5: Mini-Games (MVP - 6 Games)

See `MINI_GAMES.md` for detailed specs.

**Required for Christmas:**
1. Speed Math (DONE - currently implemented)
2. Multiple Choice Trivia
3. True/False Questions
4. Spelling Bee
5. Color Pattern Match
6. Memory Match

**Implementation:**
- Create question generators for each type
- Update `challengeGenerator.js` to randomly select game types
- Each game type has specific validation logic in `answerValidator.js`

---

## UI Design Guidelines

### Main Screen (TV)
- **Font sizes:** 48px+ body, 72px+ headings
- **Readable from 10 feet away**
- **High contrast**
- **Centered layouts**
- **Full-screen background images**
- **Smooth transitions**
- **Festive Christmas colors**

### Player Screen (Phone)
- **Font sizes:** 18px+ (standard mobile)
- **Touch targets:** 44px+ minimum
- **Single column layout**
- **Minimal scrolling**
- **Simple, not distracting**
- **Large input fields and buttons**

---

## Technical Architecture

### Server State Management

```javascript
// Game state structure
{
  roomCode: 'ABC123',
  coordinator: socketId,
  players: [{ id, name, age }],
  gameState: 'LOBBY', // Current state
  currentRound: 0,    // 1-15
  currentSection: 0,  // 1-5
  sectionStars: [0, 0, 0, 0, 0], // Stars earned per section
  scores: { playerId: points },
  playerAges: { playerId: age },
  medianAge: 12,
  currentChallenge: { question, correctAnswer, type, ... },
  sectionResults: [] // Results for current section
}
```

### Information Flow

```
Main Screen (TV)          Server              Player Devices
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              â”‚         â”‚      â”‚            â”‚              â”‚
â”‚  Story       â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”¤      â”‚            â”‚  Input       â”‚
â”‚  Questions   â”‚         â”‚ Game â”‚            â”‚  Submit      â”‚
â”‚  Results     â”‚         â”‚ Stateâ”‚            â”‚  Feedback    â”‚
â”‚  Scoreboard  â”‚         â”‚      â”‚            â”‚              â”‚
â”‚              â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚      â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”˜            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Everyone watches         Validates            Personal
together                 & scores             controller
```

**Events:**
- `game-state-update` â†’ Both screens
- `challenge-data` â†’ Main screen shows question
- `submit-answer` â†’ Players send answers
- `challenge-results` â†’ Both screens (full results vs personal)
- `section-complete` â†’ Both screens
- `section-failed` â†’ Both screens

---

## Success Criteria

**Main Screen Test:**
- âœ… Can play entire game by only watching TV
- âœ… Everything readable from 10 feet away
- âœ… Looks like professional party game

**Player Screen Test:**
- âœ… Can submit answers without looking at phone
- âœ… Simple input controller only
- âœ… No distracting story content

**Game Flow Test:**
- âœ… Failing section triggers retry
- âœ… Stars calculated correctly
- âœ… Game ends when all sections have 3 stars
- âœ… Fully autonomous (no manual controls)

---

## Timeline

**Immediate (Next 2-3 hours):**
- [ ] Fix screen architecture
- [ ] Implement star system
- [ ] Fix scoring (remove placement bonuses)

**Today (Dec 24):**
- [ ] Artwork integration
- [ ] 3-4 additional mini-games
- [ ] Full playthrough testing

**Christmas Eve/Day:**
- [ ] Final polish
- [ ] Remaining mini-games
- [ ] Cloud deployment
- [ ] Family testing

---

**Last Updated:** December 24, 2024
**Status:** Screen architecture redesign in progress
